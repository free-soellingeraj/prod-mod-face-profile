---

title: client


keywords: fastai
sidebar: home_sidebar

summary: "Defines the methods required for making requests to the face profile."
description: "Defines the methods required for making requests to the face profile."
nb_path: "nbs/01_client.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_client.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/fortville/.local/lib/python3.6/site-packages/torch/cuda/__init__.py:52: UserWarning: CUDA initialization: Unexpected error from cudaGetDeviceCount(). Did you run some cuda functions before calling NumCudaDevices() that might have already set an error? Error 804: forward compatibility was attempted on non supported HW (Triggered internally at  /pytorch/c10/cuda/CUDAFunctions.cpp:100.)
  return torch._C._cuda_getDeviceCount() &gt; 0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">prcvd.core</span> <span class="kn">import</span> <span class="n">json_to_dict</span>
<span class="kn">from</span> <span class="nn">prcvd.exceptions</span> <span class="kn">import</span>  <span class="p">(</span>
    <span class="n">UnexpectedInputProvided</span><span class="p">,</span> <span class="n">ExpectedInputMissing</span><span class="p">,</span> 
    <span class="n">DataTypeNotImplemented</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">prcvd.serving.ubiops</span> <span class="kn">import</span> <span class="p">(</span><span class="n">UbiOpsClient</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">imgs</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/data1/data/skin-tone/from_zenodo/Media/MediaForExport&#39;</span><span class="p">)</span>
<span class="n">ls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fp</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span> 
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.jpg&#39;</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">SECRETS_FP</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">))</span><span class="o">/</span><span class="s1">&#39;code/.secrets/ubiops.json&#39;</span>
<span class="n">secrets</span> <span class="o">=</span> <span class="n">json_to_dict</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">SECRETS_FP</span><span class="p">)</span>
<span class="n">OUTPUT_SPEC_FP</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;ubiops_output_spec.json&#39;</span>
<span class="n">output_spec</span> <span class="o">=</span> <span class="n">json_to_dict</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">OUTPUT_SPEC_FP</span><span class="p">)</span>
<span class="n">INPUT_SPEC_FP</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;ubiops_input_spec.json&#39;</span>
<span class="n">input_spec</span> <span class="o">=</span> <span class="n">json_to_dict</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">INPUT_SPEC_FP</span><span class="p">)</span>

<span class="n">PROJECT_NAME</span> <span class="o">=</span> <span class="s2">&quot;facial-profile&quot;</span>
<span class="n">DEPLOYMENT_NAME</span> <span class="o">=</span> <span class="s1">&#39;endtoend-3&#39;</span>
<span class="n">DEPLOYMENT_VERSION</span> <span class="o">=</span> <span class="s1">&#39;v2&#39;</span>    <span class="c1">#TODO: how to get latest?</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">UbiOpsClient</span><span class="p">(</span>
    <span class="n">project_name</span><span class="o">=</span><span class="n">PROJECT_NAME</span><span class="p">,</span> <span class="n">deployment_name</span><span class="o">=</span><span class="n">DEPLOYMENT_NAME</span><span class="p">,</span> 
    <span class="n">deployment_version</span><span class="o">=</span><span class="n">DEPLOYMENT_VERSION</span><span class="p">,</span> <span class="n">input_spec</span><span class="o">=</span><span class="n">input_spec</span><span class="p">,</span>
    <span class="n">output_spec</span><span class="o">=</span><span class="n">output_spec</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">secrets</span><span class="p">[</span><span class="s1">&#39;API_TOKEN&#39;</span><span class="p">],</span> 
    <span class="n">api_host</span><span class="o">=</span><span class="n">secrets</span><span class="p">[</span><span class="s1">&#39;HOST&#39;</span><span class="p">]</span>
    
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;img&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;sampling_strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;use_all&#39;</span><span class="p">,</span>
    <span class="s1">&#39;align_face&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;num_attempts&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-49-b49ccced7b9b&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span> }
<span class="ansi-green-intense-fg ansi-bold">      7</span> r <span class="ansi-blue-fg">=</span> client<span class="ansi-blue-fg">.</span>request<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">=</span>data<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 8</span><span class="ansi-red-fg"> </span>output <span class="ansi-blue-fg">=</span> client<span class="ansi-blue-fg">.</span>post_process<span class="ansi-blue-fg">(</span>response<span class="ansi-blue-fg">=</span>r<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.local/lib/python3.6/site-packages/prcvd/serving/client.py</span> in <span class="ansi-cyan-fg">post_process</span><span class="ansi-blue-fg">(self, response)</span>
<span class="ansi-green-intense-fg ansi-bold">    127</span>         <span class="ansi-blue-fg">&#34;&#34;&#34;&#34;&#34;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    128</span>         <span class="ansi-green-fg">if</span> response<span class="ansi-blue-fg">.</span>ok<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 129</span><span class="ansi-red-fg">             </span>output <span class="ansi-blue-fg">=</span> json<span class="ansi-blue-fg">.</span>loads<span class="ansi-blue-fg">(</span>response<span class="ansi-blue-fg">.</span>content<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    130</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    131</span>             <span class="ansi-green-fg">raise</span> Exception<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;Failed HTTP request, no return.&#34;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;json&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">r</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">MaskedImg</span><span class="p">()</span>
<span class="n">img</span><span class="o">.</span><span class="n">load_from_bytes</span><span class="p">(</span><span class="n">bytestr</span><span class="o">=</span><span class="n">blob_data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-43-f5342794953c&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-red-fg"># type(blob_data.data)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> img <span class="ansi-blue-fg">=</span> MaskedImg<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 3</span><span class="ansi-red-fg"> </span>img<span class="ansi-blue-fg">.</span>load_from_bytes<span class="ansi-blue-fg">(</span>bytestr<span class="ansi-blue-fg">=</span>blob_data<span class="ansi-blue-fg">.</span>data<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">AttributeError</span>: &#39;MaskedImg&#39; object has no attribute &#39;load_from_bytes&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converted 00_core.ipynb.
Converted 01_client.ipynb.
Converted 2020-10-12-Training a Face Segmentation Model for Automatic Skin Tone Detection.ipynb.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-Endpoint">The Endpoint<a class="anchor-link" href="#The-Endpoint"> </a></h2><h3 id="Notes">Notes<a class="anchor-link" href="#Notes"> </a></h3><ol>
<li>Is a blob a dictionary?  If so, this should work. Use the "json editor" on create a deployment.</li>
<li><a href="https://www.freecodecamp.org/news/what-we-learned-by-serving-machine-learning-models-using-aws-lambda-c70b303404a1/https://www.freecodecamp.org/news/what-we-learned-by-serving-machine-learning-models-using-aws-lambda-c70b303404a1/">https://www.freecodecamp.org/news/what-we-learned-by-serving-machine-learning-models-using-aws-lambda-c70b303404a1/https://www.freecodecamp.org/news/what-we-learned-by-serving-machine-learning-models-using-aws-lambda-c70b303404a1/</a></li>
</ol>
<h2 id="Notes">Notes<a class="anchor-link" href="#Notes"> </a></h2><ol>
<li>is there a way to create the blob without importing ubiops? Yes (requests)</li>
<li>does requests encrypt my api key in transit?  Does ubiops?</li>
<li>make the request asynchronous, non-blocking</li>
<li>the documentation here, I think the vocabulary is confusing.  <a href="https://ubiops.com/docs/tutorials/quickstart/">https://ubiops.com/docs/tutorials/quickstart/</a>
(try just using code samples?)  I didn't find any code samples to show how to actually make a request.</li>
<li>Can I generalize the ubiops to make it work for multiple deployments?<ol>
<li>handles inputs DONE</li>
<li>makes requests DONE</li>
<li>(async/await)</li>
<li>parses response DONE</li>
<li>serializes and saves data </li>
<li>caches requests</li>
</ol>
</li>
</ol>

</div>
</div>
</div>
</div>
 

